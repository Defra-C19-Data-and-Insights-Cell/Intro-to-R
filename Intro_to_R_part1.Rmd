---
title: "Introduction to R - Session 1"
author: "Defra R Training Group"
date: "Spring 2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### This session will cover:
* What is R and R Studio?
* Installing and using R Packages
* Reading in and filtering data
* Reformatting data and basic data cleaning
* Basic graphs

## Why learn R?
* Makes you think in terms of a workflow which is
        * Repeatable to other cases
        * Reproducible
        * Easy to maintain
* Longevity: code becomes out of date very very slowly if at all
* The breadth of what you can do: pretty much anything with data
* Web apps (shiny) and automated reporting (RMarkdown)
* Helpful support community
* Transferable skill for life
* Productivity (although learning a new skill can lead to a productity dip!)

Also see https://fantasyfootballanalytics.net/2014/01/why-r-is-better-than-excel.html

## Preparing for the training session

The session is run in a 'code-along' format, therefore **we recommend that you use a second screen if you have access to one** or a second device. This is because it will be easiest for you to see the teacher's screen and your own code at the same time. Additionally, you might find it helpful to have a print-out of the course materials (this html page).

You do not need to have R and R Studio installed on your computer. For the purposes of the training session we use RStudio cloud because all you need is a browser (we recommend Google Chrome or Microsoft Edge, definitely not Internet Explorer) so there is nothing to configure and no dedicated hardware, installation or annual purchase contract required. 

You can sign up for a free "Cloud Free" account that allows you to create up to 15 projects, and use up to 15 project hours per month.

You can also run the training materials on an up to date local installation of R/RStudio, but there may be a few minor differences - the instructions below assume you're using RStudio cloud.

When you're working through the materials, we recommend that you type the commands rather than using cut-paste.

**Before the training session, please make sure you have:**

**1) Have Google Chrome or Microsoft Edge installed on your computer.**

**2) Signed up for an account [here.](https://rstudio.com/products/cloud/)**

**3) Created a new project by clicking on the 'New Project' button, and given your project a name**

<!-- ![R Studio Cloud Projects](Cloud_projects.JPG) -->

Note that in RStudio Cloud you must work in a project. 

RStudio projects make it straightforward to divide your work into multiple contexts, each with their own working directory, workspace, history, and source documents. On RStudio Desktop you don't have to work in projects but WE STRONGLY RECOMMEND THAT YOU DO. You can read more about using Projects [here.](https://support.rstudio.com/hc/en-us/articles/200526207-Using-Projects) and see here for some more helpful background [here.](https://martinctc.github.io/blog/rstudio-projects-and-working-directories-a-beginner's-guide/)

If you've used R before, especially if some time ago, you may have come across code which uses the R function setwd("path/to/my/data"). This is not good practice and is not necessary when using projects.

Likewise previous R users may have come across the attach() function. Again you should not use this, it is not good practice.

**RStudio Cloud may not be suitable for official work purposes so please only use it for learning and training purposes.**

## What is R & R Studio?

<!-- ![](r_rstudio.jpg) -->

#### What is R?
R is a computer language and environment for data manipulation, data analysis and graphical display. 
Importantly R is a free, open source software which means it is accessible to all and is continually  improving. Although there are other computer languages, notably Python, used in data science, we recommend R for data science unless you've already had some exposure to Python and are comfortable with it.

#### What is RStudio?
RStudio is an integrated development environment (IDE) for R. Basically it makes using R alot easier. It includes a console, syntax-highlighting editor that supports direct code execution, as well as tools for plotting, history, debugging and workspace management. RStudio is available in open source and commercial editions and runs on the desktop (Windows, Mac, and Linux) or in a browser connected to RStudio Server or RStudio Server Pro. Rstudio is developed and maintained by the US company RStudio, and is a good example of how commercial companies can make a business from open source software. 

<!-- ![](rstudio_session_4pane_layout.jpg) -->

## Getting the training data into RStudio Cloud

Once you have the zip file of training materials, start up RStudio Cloud and go to your new project that you created above. In the bottom right window, under the Files tab, you'll see a button called Upload. Click on that, and follow the instructions to upload your zipped file. RStudio will automatically unzip the files and place them in your project. This includes the training documents themselves, which don't need to be available to R, but it's no harm to have them there. 

<!-- ![](upload_button.png) -->

## Getting set up
Although we can type R commands into the console window (bottom left), it's better to type commands into a script which we can save for future use. From a script we can run an individual line of code, a block of code or the entire script.

To set up a new blank script, click on the little plus sign in the top left of your screen underneath File.
<!-- ![](file_pane.JPG) -->

It's good practice to put a name, a date and author in scripts.

```{r }
# Intro to R part 1
# Date: the current date
# Author: name
```
You can use # to add notes throughout your script, the # means R knows not to try and run the line as code. Except for the install.packages() command below, type the other commands below into your script. You can save your script regularly.

**Note: all code in this session is shown in a grey box as above.**

## Packages

R packages are collections of functions and data sets developed by the community. R Packages are available for download from repositories. The official, and virtually only repository you'll ever need, is CRAN. The R foundation coordinates it, and for a package to be published here, it needs to pass several tests that ensure the package is following CRAN policies. Although you or your organization might have a local repository, typically they are online and accessible to everyone. Some packages, especially those in development, are not on CRAN and are only available from github.

## Installing packages

The first time you use a package on your computer you need to install it. This gets the package from the repository (generally CRAN) and puts it onto your computer (or your project in RStudio cloud).

You can do this with the install.packages() function. Type this command into the console, not in your script, as you won't need to re-run it if you come back to your script another time.

``` {r, eval = FALSE}
install.packages("tidyr") 
```
**Note: to run a line of code in R you click the line of code you want to run, then press Ctrl+Enter or click the Run button.**

Here we are only going to install one package called tidyr. Most of the time today we are going to use the functions built-in to R ("base R").

Note that when using RStudio Cloud, each separate project has its own package library, so if you create another project you will need to install your required packages from scratch. This is different from running R on your local computer (or in a virtual machine) where the default is a single package library available to any project. 

## Loading packages

library() is the command used to load a package into a R session. At first the difference between installing a package with install.packages() and loading a package with library() can be confusing.

> "a package is a like a book, a library is like a library; you use library() to check a package out of the library" - Hadley Wickham
 
``` {r, message = TRUE}
library(tidyr) # we are back typing commands in your script now
# note no use of " " when using library command
```

## Code not working?
Common causes of error:

* no "" when needed (and vice versa)
* mispelling
* wrong number of ()
* wrong case: pretty much everything in R is case sensitive

<!-- ![](spell_check.jpg) -->


### Warnings
Warnings are shown when R has encountered a problem processing some part of your commands, but can continue processing the other commands. However, the result might not be what you would expect, so you should
carefully examine all variables used in the command that triggered the warning.

### Errors
Errors mean R cannot continue processing your commands and returns to the command prompt showing a brief description of the error.

### Reading data into R

Use the read.csv() function to read your data (stored in a csv file) into R. Here we read the data in the csv file into R and store it in a data frame called crops_data. A data frame is an R data structure, basically a rectangular matrix of data where each column is named. Each column can have a different data type, but unlike Excel, everything in a single column must have the same data type. Integer, decimal, character are the most common data types. The <- symbol is called the assignment operator or just assign, it's just the less than (<) character immediately followed by the minus sign (-). Note the spaces either side of <-, these are not essential but help readability. But there must NOT be a space between < and -. Likewise there must not be a space between read.csv and the open bracket.

__KEYBOARD SHORTCUT__ Alt and - (press Alt and the minus sign together). This will produce the assigment operator correctly for you and save typing time.

```{r}
crops_data <- read.csv("june_survey_data.csv")
```

### Looking at your data

There are various different ways to look at your data in R, try each of these and look at the differences between them. 

```{r, eval = FALSE}
crops_data
View(crops_data) # or click in the Environment pane on the R object you would like to view
str(crops_data)
```

You'll see that most of the columns are years, and that R has put a X in front of the year number. This is because R doesn't like variable names (including column names) to start with a number. Likewise R doesn't like most punctuation characters in variable names, for example brackets. For your own names it's best to stick to upper or lower case characters, numbers (but not at the beginning of the name), the underscore and dot characters (_ and .). With this dataset, we will sort out these issues later.


## Data wrangling

Data wrangling is about getting your data in the right format to be able to analyse it. The next few steps take you through common data wrangling problems and how you can solve them in R. 

#### Removing a row 

In this case, we don't need the totals on the first row. Using one of the ways above, look at your data after you've run the command. 
```{r}
crops <- crops_data[-1, ] # before comma = row
```

The -1 means remove row number 1. 

#### Removing a column

We also don't need the 1983 column (the 2nd column). Again, view your data afterwards.

```{r}
crops <- crops[, -2] # after comma = column. It's good practice to put a space after the comma
```

#### Removing multiple rows
Only select data we are interested in by retaining the first 10 rows at the beginning of the dataset
```{r}
crops <- crops[c(1:10),]
```

There are other ways to select rows and columns. You can select a single column by name

```{r}
crops$Crop # note the different display format when R is showing a single vector of data 
```

And combine selecting rows and columns, for example
```{r}
crops[1:5, c("Crop", "X1984")] # Note use of c("","") when selecting multiple columns 
```

It is best practice to select rows or columns by name, this can help avoid erroneous results if there are changes to the format of the data.

In R you can use either single or double quotes, but don't mix the two in the same line of code. It's best to stick to one or the other.

## Tidy data

Making a dataset 'tidy' is part of the data wrangling process in R. 

Tidy data is a standard way of mapping the meaning of a dataset to its structure. A dataset is messy or tidy depending on how rows, columns and tables are matched up with observations, variables and types. 

<!-- ![](tidy-1.jpg) -->

There 3 main qualities of tidy data:

* Each variable forms a column
* Each observation forms a row
* Each type of observational unit forms a table

<!-- ![](tidy-9.jpg) -->

We use the pivot_longer() function from the tidyr package here to make our data set tidy. We create a new data frame called arable. We've kept our original data frame called crops_data and our intermediate data frame called crops, in case anything goes wrong and we have to refer back to them. You'll see that the output of pivot_longer() is a "tibble" this is just a neat type of data frame. Don't worry about this for now, we'll look at tibbles some more in Session 2. 
```{r}
arable <- pivot_longer(crops, cols = -Crop, names_to = "Year", values_to = "Area") 
# similar to copying and pasting using rows to columns in excel
arable # take a look
```

read.csv was our first R function, but this is our first example of using an R function with multiple arguments (arguments are just anything within the brackets of the function name. Each argument other than the first is named, using the syntax argument = value. 
We are passing four arguments to pivot_longer:

* Firstly, crops is the data frame we're working on. We've not named this argument by convention, but we could have said data = crops.
* Secondly using the cols = argument we are saying which columns of our data frame we want to transform. In this instance it's everything EXCEPT the Crop column so we say -Crop
* Thirdly using names_to = argument we say what name will we give to the new column which will contain the information in the transformed columns (everything except Crop, ie X1984, X1985 etc)
* Finally with the values = argument we set the name of the new column that will hold all the data from the transformed columns.  

Anyone using R, however experienced, is not going to remember the arguments of most of the functions they use. Fortunately it's easy to bring up a help page for any R function:
```{r eval = FALSE}
?pivot_longer()
```

In this example we have used a function from a package. In many cases, packages add functionality that is simply not present in base R. This is one of many cases where we COULD have used a function in base R (in this case that's called reshape). However in this case we use pivot_longer because it's so much easier to use than reshape. We will come across other situations in Session 2 where we choose to use functions in packages rather than their base R equivalents.

You can read more about tidy data [here.](https://r4ds.had.co.nz/tidy-data.html) and [here.](https://peerj.com/preprints/3183.pdf)

Of course it's better if your data are tidy in the first place, but we often have to deal with "untidy" data!

## Clean data

Data cleaning is the process of preparing data for analysis by removing or modifying data that is incorrect, incomplete, irrelevant, duplicated, or improperly formatted data. 

#### Removing unwanted characters
Here we're using the function gsub() to remove unwanted characters from the dataset, these were either in the original dataset or were created when the read.csv function renamed the year columns to valid R object names. 
The gsub() function performs character replacement in strings. Strings are a non-numerical type of R data, others include logical, integer and double but more on that later.
Our gsub() code uses three arguments; 1st is the string pattern to replace wrapped in quotes, "X" in our case. 2nd is the replacement character or pattern in quotes, "" which is nothing in our case, we want to remove X. Finally we say what object we want to apply this to, the column arable$Year. The next line of code for removing "g" should be easier for you to interpret and follows the same logic. Finally, to remove all other unwanted punctuation we use gsub() again with a "regular expression" or regex. Do not worry about these yet, even for experienced R users regular expressions can be tricky but they are very powerful when dealing with text based datasets that you may encounter at some point. 
```{r}
arable$Year <- gsub("X", "", arable$Year) # removes the Xs
arable$Year <- gsub("g", "", arable$Year) # removes the letter g

arable$Year <- gsub("[[:punct:]]", "", arable$Year) # [[:punct:]] removes all punctuation

```

#### Removing spaces

Because of the format of the original data, there are spaces in the numbers in the area column. We remove those. NOTE THE SPACE BETWEEN QUOTES IN THE FIRST ARGUMENT.
```{r}
arable$Area <- gsub(" ", "", arable$Area) # removes spaces
```

#### Replacing values in data
There are two sets of entries for 2009, one called 2009 and one called revised. First we remove the "old" 2009 data using the subset function In this case we just over-write the arable data frame. Then we rename every occurrence of "revised" to 2009.  
```{r}
arable <- subset(arable, Year != 2009) # filter out 2009 as it has been revised (two 2009 columns)
arable$Year[arable$Year == "revised"] <- 2009 # replacing the occurrences of "revised"with "2009" 
```


#### Data types

R has a wide variety of data types including scalars (a single piece of data), vectors - a series of bits of data of the same type (numerical, character, logical), matrices, data frames, and lists. 

R will automatically set data types when you read text files into R, however, sometimes R will not do what you want so you may need to change.
Data types determine how the data is stored in your computer and how analysis/visualization will treat variables. You can read more about data types in R [here.](https://www.statmethods.net/input/datatypes.html)

Change variable data types, from character (text) to numeric. In the original dataset, there were some blank entries which were stored as ".." - these are why the values were imported as character rather than numeric in the first place. When we change Area to numeric, these will be specifically flagged as missing values with the special value NA, and you'll get a message from R that it's done this. Unlike Excel, R is good at handling missing data.  
```{r}
arable$Year <- as.integer(arable$Year) # Make year an integer
arable$Area <- as.numeric(arable$Area) # Make area numeric
```

#### Remove NAs
Actually we don't want the NAs at all, so we need to remove these but before doing that it's worth checking where the NAs are. Our first line of code does two things, reading from the inside the function is.na() returns a 1 if NA is found and 0 otherwise. The colSums() function is wrapped around is.na() and adds up the 1s so we can clearly see where the NAs occur. This is good practice because running the next line of code removes all NAs from the dataframe which in this instance is ok. In datasets with more columns you may have NAs in other columns but not on the same rows so applying na.omit() to a dataset may give unwelcome results. There are other functions that allow you to be more selective with handling NAs but that is outside this session.
```{r}
colSums(is.na(arable))
arable <- na.omit(arable)
```

#### Subsetting  
For the rest of our analysis we only want data since 2008. Here we create a new data frame called arable_sub. This is achieved by using "logical operators" such as >(greater than), <(less than), <=(less than or equal to), == (equal to), != (not equal to). It is worth remembering these operators, and learning others, as you work with R.
```{r}
arable_sub <- subset(arable, Year >= 2008) # similarly can use these: >, <, <=, ==, !=
```

#### Filtering for multiples values or categories
```{r}
crop_list <- c("wheat", "barley", "oilseed rape")
arable_sub <- subset(arable_sub, Crop %in% crop_list)
```

subset() is a base R function so doesn't require any additional packages. In session 2 we will introduce the filter() function which  is part of dplyr in the tidyverse set of packages. Filter works quicker in big datasets and can operate on SQL databases without pulling the data in R's memory. There are a few other technical differences which we won't go into here. 
The %in% operator is another good one to memorise, used with subset() or filter() you are telling R that you only want crops that are in your list. 

## Basic graphs
We're going to finish off this first session by making a very basic graph using base R commands. We'll produce some better graphs in Session 2. 

Note that we're using the plot function which has multiple arguments, and that we're splitting it over multiple lines for readability. This is OK, if you don't run the code up to the last closed bracket R will know the command isn't finished and just wait for more input. Note that we're using the $ syntax to refer to individual columns within the arable_sub data frame. 
We're also creating a factor (f) by which to control the plotting characters, factors are how you deal with categorical variables and they have 'levels' such as factor gender can have levels (m/f/other), treatment(drug/placebo) or size(s/m/l/xl) and many other ways we divide things up into groups. 
```{r, echo=TRUE}
f <- factor(arable_sub$Crop)

plot(x = arable_sub$Year, y = arable_sub$Area,
     pch = as.integer(f),
     cex = 2,
     xlab = "Year",
     ylab = "Area (ha)")
```


# Help

For general help: 

* [R Cookbook](http://www.cookbook-r.com/)
* [R Cheatsheets](https://www.rstudio.com/resources/cheatsheets/)
* [Quick-R](https://www.statmethods.net/index.html)
* [R4 Data Science](https://stat545.com/)

For data organisation in spreadsheets [here.](https://peerj.com/preprints/3183.pdf)

For graphs:

* [ggplot2 book](https://ggplot2-book.org/index.html)
* [R Cookbook](http://www.cookbook-r.com/Graphs/) 
* [BBC R Cookbook](https://bbc.github.io/rcookbook/)

For outputting graphs see [here.](http://www.cookbook-r.com/Graphs/Output_to_a_file/) 

Defra community:

* Defra Coffee and Coding
* [Data Science Yammer](https://www.yammer.com/defra.onmicrosoft.com/#/threads/inGroup?type=in_group&feedId=16126135)
* R Training Group

Online community for help: 
* First try google. Most questions have been asked before. 
* [Stack overflow](https://stackoverflow.com/) 

 
